<!-- views/admin/analytics.ejs -->
<div class="dashboard-container">
  <%- include('../partials/sidebar') %>

  <div id="mainContent" class="main-content">
    <div class="welcome-header mb-4">
      <h2 class="dashboard-title">
        <i class="fas fa-chart-line me-3"></i>
        Analytics Dashboard
      </h2>
      <p class="dashboard-subtitle">Advanced performance analytics and insights</p>
    </div>

    <!-- Key Metrics -->
    <div class="row g-4 mb-4">
      <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
          <div class="card-body">
            <div class="display-6 text-primary fw-bold"><%= stats.totalStudents %></div>
            <div class="text-muted">Total Students</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
          <div class="card-body">
            <div class="display-6 text-success fw-bold"><%= stats.totalResults %></div>
            <div class="text-muted">Total Results</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
          <div class="card-body">
            <div class="display-6 text-info fw-bold">
              <%= stats.passRate ? Math.round((stats.passRate.passed / stats.passRate.total) * 100) : 0 %>%
            </div>
            <div class="text-muted">Pass Rate</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
          <div class="card-body">
            <div class="display-6 text-warning fw-bold">
              <%= stats.gradeDistribution.filter(g => ['A', 'B', 'C'].includes(g.grade)).reduce((sum, g) => sum + parseInt(g.count), 0) %>
            </div>
            <div class="text-muted">Distinctions</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Analytics -->
    <div class="row g-4 mb-4">
      <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
          <div class="card-body">
            <div class="display-6 text-success fw-bold">₦<%= stats.monthlyPayments.toLocaleString() %></div>
            <div class="text-muted">Monthly Revenue</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
          <div class="card-body">
            <div class="display-6 text-primary fw-bold">₦<%= stats.yearlyPayments.toLocaleString() %></div>
            <div class="text-muted">Yearly Revenue</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
          <div class="card-body">
            <div class="display-6 text-warning fw-bold"><%= stats.pendingPayments %></div>
            <div class="text-muted">Pending Payments</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
          <div class="card-body">
            <div class="display-6 text-danger fw-bold"><%= stats.failedPayments %></div>
            <div class="text-muted">Failed Payments</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Grade Distribution Chart -->
    <div class="card shadow-sm border-0 rounded-4 mb-4">
      <div class="card-header bg-transparent border-0">
        <h5 class="fw-bold mb-0">
          <i class="fas fa-chart-pie me-2"></i>
          Grade Distribution
        </h5>
      </div>
      <div class="card-body">
        <div style="max-width: 400px; margin: 0 auto;">
          <canvas id="gradeChart" width="400" height="400"></canvas>
        </div>
      </div>
    </div>

    <!-- Payment Methods Chart -->
    <div class="card shadow-sm border-0 rounded-4 mb-4">
      <div class="card-header bg-transparent border-0">
        <h5 class="fw-bold mb-0">
          <i class="fas fa-credit-card me-2"></i>
          Payment Methods Distribution
        </h5>
      </div>
      <div class="card-body">
        <div style="max-width: 400px; margin: 0 auto;">
          <canvas id="paymentChart" width="400" height="400"></canvas>
        </div>
      </div>
    </div>

    <!-- Performance Trends -->
    <div class="row g-4">
      <div class="col-md-6">
        <div class="card shadow-sm border-0 rounded-4">
          <div class="card-header bg-transparent border-0">
            <h5 class="fw-bold mb-0">
              <i class="fas fa-trending-up me-2"></i>
              Subject Performance
            </h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Subject</th>
                    <th>Avg Score</th>
                    <th>Pass Rate</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (stats.subjectPerformance && stats.subjectPerformance.length > 0) { %>
                    <% stats.subjectPerformance.forEach(subject => { %>
                      <tr>
                        <td><%= subject.name %></td>
                        <td><span class="badge bg-primary"><%= subject.avgScore ? subject.avgScore.toFixed(1) : 'N/A' %></span></td>
                        <td><span class="badge bg-success"><%= subject.passRate ? Math.round(subject.passRate) + '%' : 'N/A' %></span></td>
                      </tr>
                    <% }); %>
                  <% } else { %>
                    <tr>
                      <td colspan="3" class="text-center text-muted">No subject performance data available</td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm border-0 rounded-4">
          <div class="card-header bg-transparent border-0">
            <h5 class="fw-bold mb-0">
              <i class="fas fa-credit-card me-2"></i>
              Recent Payments
            </h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Student</th>
                    <th>Amount</th>
                    <th>Method</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (stats.recentPayments && stats.recentPayments.length > 0) { %>
                    <% stats.recentPayments.forEach(payment => { %>
                      <tr>
                        <td><%= payment.Student ? payment.Student.name : 'N/A' %></td>
                        <td><span class="badge bg-success">₦<%= payment.amount %></span></td>
                        <td><span class="badge bg-info"><%= payment.paymentMethod %></span></td>
                        <td><%= new Date(payment.createdAt).toLocaleDateString() %></td>
                      </tr>
                    <% }); %>
                  <% } else { %>
                    <tr>
                      <td colspan="4" class="text-center text-muted">No recent payments</td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Grade Distribution Chart
const gradeData = <%- JSON.stringify(stats.gradeDistribution) %>;
const ctx = document.getElementById('gradeChart').getContext('2d');

new Chart(ctx, {
  type: 'doughnut',
  data: {
    labels: gradeData.map(g => `Grade ${g.grade}`),
    datasets: [{
      data: gradeData.map(g => g.count),
      backgroundColor: [
        '#28a745', // A - Green
        '#007bff', // B - Blue  
        '#17a2b8', // C - Cyan
        '#ffc107', // D - Yellow
        '#6c757d', // E - Gray
        '#dc3545'  // F - Red
      ],
      borderWidth: 2,
      borderColor: '#fff'
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    aspectRatio: 1,
    plugins: {
      legend: {
        position: 'bottom',
        labels: {
          padding: 20,
          usePointStyle: true
        }
      }
    }
  }
});

// Payment Methods Chart
const paymentData = <%- JSON.stringify(stats.paymentMethods) %>;
const paymentCtx = document.getElementById('paymentChart').getContext('2d');

new Chart(paymentCtx, {
  type: 'doughnut',
  data: {
    labels: paymentData.map(p => p.method),
    datasets: [{
      data: paymentData.map(p => p.count),
      backgroundColor: [
        '#28a745', // Card
        '#007bff', // Bank Transfer
        '#17a2b8', // USSD
        '#ffc107', // Wallet
        '#6c757d', // Other
        '#dc3545'  // Cash
      ],
      borderWidth: 2,
      borderColor: '#fff'
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    aspectRatio: 1,
    plugins: {
      legend: {
        position: 'bottom',
        labels: {
          padding: 20,
          usePointStyle: true
        }
      }
    }
  }
});
</script>