<!-- views/admin/gazette.ejs -->
<div class="dashboard-container">
  <%- include('../partials/sidebar') %>

  <div id="mainContent" class="main-content">
    <div class="welcome-header mb-4">
      <h2 class="dashboard-title">
        <i class="fas fa-newspaper me-3"></i>
        BECE Gazette
      </h2>
      <p class="dashboard-subtitle">Official publication of examination results</p>
    </div>

    <!-- Gazette Header -->
    <div class="card shadow-sm border-0 rounded-4 mb-4">
      <div class="card-body text-center py-5">
        <img src="/images/bece-logo.svg" alt="BECE Logo" style="width: 80px; height: 80px;" class="mb-3">
        <h3 class="fw-bold text-primary">FEDERAL REPUBLIC OF NIGERIA</h3>
        <h4 class="fw-bold">BASIC EDUCATION CERTIFICATE EXAMINATION</h4>
        <h5 class="text-muted">OFFICIAL GAZETTE</h5>
        <div class="mt-3">
          <span class="badge bg-primary fs-6 px-3 py-2">
            <i class="fas fa-calendar me-2"></i>
            <%= new Date().getFullYear() %> EXAMINATION RESULTS
          </span>
        </div>
      </div>
    </div>

    <!-- Filter Options -->
    <div class="card shadow-sm border-0 rounded-4 mb-4">
      <div class="card-header bg-transparent border-0">
        <h5 class="fw-bold mb-0">
          <i class="fas fa-filter me-2"></i>
          Filter Results
        </h5>
      </div>
      <div class="card-body">
        <form action="/admin/export/gazette" method="GET" class="row g-3">
          <div class="col-md-3">
            <label class="form-label fw-bold">Examination Year</label>
            <select name="year" class="form-control">
              <% const currentYear = new Date().getFullYear(); %>
              <% for (let i = 0; i < 5; i++) { %>
                <option value="<%= currentYear - i %>" <%= i === 0 ? 'selected' : '' %>>
                  <%= currentYear - i %>
                </option>
              <% } %>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-bold">State</label>
            <select name="state" class="form-control">
              <option value="">All States</option>
              <% states.forEach(state => { %>
                <option value="<%= state.id %>"><%= state.name %></option>
              <% }) %>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-bold">Grade Filter</label>
            <select name="grade" class="form-control">
              <option value="">All Grades</option>
              <option value="A">Grade A (Distinction)</option>
              <option value="B">Grade B (Credit)</option>
              <option value="C">Grade C (Credit)</option>
              <option value="D">Grade D (Pass)</option>
              <option value="E">Grade E (Pass)</option>
              <option value="F">Grade F (Fail)</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-bold">Format</label>
            <select name="format" class="form-control">
              <option value="csv">CSV Download</option>
              <option value="pdf">PDF Gazette</option>
              <option value="excel">Excel Report</option>
            </select>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary me-2">
              <i class="fas fa-download me-2"></i>
              Generate Gazette
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="previewGazette()">
              <i class="fas fa-eye me-2"></i>
              Preview
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Statistics Summary -->
    <div class="row g-4 mb-4">
      <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
          <div class="card-body">
            <div class="display-6 text-primary fw-bold" id="totalCandidates">0</div>
            <div class="text-muted">Total Candidates</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
          <div class="card-body">
            <div class="display-6 text-success fw-bold" id="totalPassed">0</div>
            <div class="text-muted">Passed (A-E)</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
          <div class="card-body">
            <div class="display-6 text-warning fw-bold" id="totalDistinction">0</div>
            <div class="text-muted">Distinction (A-C)</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
          <div class="card-body">
            <div class="display-6 text-info fw-bold" id="totalSchools">0</div>
            <div class="text-muted">Participating Schools</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Publications -->
    <div class="card shadow-sm border-0 rounded-4">
      <div class="card-header bg-transparent border-0">
        <h5 class="fw-bold mb-0">
          <i class="fas fa-history me-2"></i>
          Recent Publications
        </h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Publication Date</th>
                <th>Examination Year</th>
                <th>Total Candidates</th>
                <th>Pass Rate</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><%= new Date().toLocaleDateString() %></td>
                <td><%= new Date().getFullYear() %></td>
                <td>45,678</td>
                <td>
                  <span class="badge bg-success">87.5%</span>
                </td>
                <td>
                  <span class="badge bg-primary">Published</span>
                </td>
                <td>
                  <button class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-download"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-info">
                    <i class="fas fa-eye"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-eye me-2"></i>
          Gazette Preview
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="previewLoading" class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Loading preview...</p>
        </div>
        <div id="previewContent" style="display: none;">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Student Name</th>
                  <th>Student Code</th>
                  <th>School</th>
                  <th>State</th>
                  <th>Subject</th>
                  <th>Score</th>
                  <th>Grade</th>
                  <th>Year</th>
                </tr>
              </thead>
              <tbody id="previewTableBody">
              </tbody>
            </table>
          </div>
          <div id="previewSummary" class="mt-3 text-muted">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="downloadFromPreview()">
          <i class="fas fa-download me-2"></i>
          Download Full Gazette
        </button>
      </div>
    </div>
  </div>
</div>

<script>
let currentFilters = {};

function previewGazette() {
  // Get current form values
  const form = document.querySelector('form[action="/admin/export/gazette"]');
  const formData = new FormData(form);
  
  currentFilters = {
    year: formData.get('year'),
    state: formData.get('state'),
    grade: formData.get('grade'),
    format: formData.get('format')
  };
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('previewModal'));
  modal.show();
  
  // Load preview data
  loadPreviewData();
}

async function loadPreviewData() {
  try {
    document.getElementById('previewLoading').style.display = 'block';
    document.getElementById('previewContent').style.display = 'none';
    
    const params = new URLSearchParams();
    if (currentFilters.year) params.append('year', currentFilters.year);
    if (currentFilters.state) params.append('state', currentFilters.state);
    if (currentFilters.grade) params.append('grade', currentFilters.grade);
    
    const response = await fetch(`/admin/gazette/preview?${params}`);
    const result = await response.json();
    
    if (result.success) {
      displayPreviewData(result.data, result.total);
    } else {
      throw new Error(result.error || 'Failed to load preview');
    }
  } catch (error) {
    console.error('Preview error:', error);
    document.getElementById('previewTableBody').innerHTML = 
      '<tr><td colspan="8" class="text-center text-danger">Failed to load preview data</td></tr>';
  } finally {
    document.getElementById('previewLoading').style.display = 'none';
    document.getElementById('previewContent').style.display = 'block';
  }
}

function displayPreviewData(data, total) {
  const tbody = document.getElementById('previewTableBody');
  const summary = document.getElementById('previewSummary');
  
  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No results found for the selected criteria</td></tr>';
    summary.innerHTML = 'No results to display';
    return;
  }
  
  tbody.innerHTML = data.map(row => `
    <tr>
      <td>${row.studentName}</td>
      <td>${row.studentCode}</td>
      <td>${row.school}</td>
      <td>${row.state}</td>
      <td>${row.subject}</td>
      <td>${row.score}</td>
      <td><span class="badge bg-${getGradeBadgeColor(row.grade)}">${row.grade}</span></td>
      <td>${row.examYear}</td>
    </tr>
  `).join('');
  
  summary.innerHTML = `Showing first ${data.length} results${total > data.length ? ` of ${total} total` : ''}`;
}

function getGradeBadgeColor(grade) {
  const colors = {
    'A': 'success',
    'B': 'primary', 
    'C': 'info',
    'D': 'warning',
    'E': 'secondary',
    'F': 'danger'
  };
  return colors[grade] || 'secondary';
}

function downloadFromPreview() {
  const params = new URLSearchParams();
  if (currentFilters.year) params.append('year', currentFilters.year);
  if (currentFilters.state) params.append('state', currentFilters.state);
  if (currentFilters.grade) params.append('grade', currentFilters.grade);
  if (currentFilters.format) params.append('format', currentFilters.format);
  
  window.location.href = `/admin/export/gazette?${params}`;
}

// Load statistics
async function loadGazetteStats() {
  try {
    const response = await fetch('/admin/gazette/stats');
    const result = await response.json();
    
    if (result.success) {
      const stats = result.stats;
      document.getElementById('totalCandidates').textContent = stats.totalCandidates.toLocaleString();
      document.getElementById('totalPassed').textContent = stats.totalPassed.toLocaleString();
      document.getElementById('totalDistinction').textContent = stats.totalDistinction.toLocaleString();
      document.getElementById('totalSchools').textContent = stats.totalSchools.toLocaleString();
    } else {
      throw new Error(result.error);
    }
  } catch (error) {
    console.error('Failed to load gazette statistics:', error);
    // Set default values on error
    document.getElementById('totalCandidates').textContent = '0';
    document.getElementById('totalPassed').textContent = '0';
    document.getElementById('totalDistinction').textContent = '0';
    document.getElementById('totalSchools').textContent = '0';
  }
}

// Update stats when filters change
function updateStats() {
  const form = document.querySelector('form[action="/admin/export/gazette"]');
  const formData = new FormData(form);
  
  const params = new URLSearchParams();
  if (formData.get('year')) params.append('year', formData.get('year'));
  if (formData.get('state')) params.append('state', formData.get('state'));
  if (formData.get('grade')) params.append('grade', formData.get('grade'));
  
  fetch(`/admin/gazette/stats?${params}`)
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        const stats = result.stats;
        document.getElementById('totalCandidates').textContent = stats.totalCandidates.toLocaleString();
        document.getElementById('totalPassed').textContent = stats.totalPassed.toLocaleString();
        document.getElementById('totalDistinction').textContent = stats.totalDistinction.toLocaleString();
        document.getElementById('totalSchools').textContent = stats.totalSchools.toLocaleString();
      }
    })
    .catch(error => console.error('Stats update error:', error));
}

// Add event listeners to form elements
document.addEventListener('DOMContentLoaded', function() {
  loadGazetteStats();
  
  // Add change listeners to filter inputs
  const filterInputs = document.querySelectorAll('select[name="year"], select[name="state"], select[name="grade"]');
  filterInputs.forEach(input => {
    input.addEventListener('change', updateStats);
  });
});
</script>