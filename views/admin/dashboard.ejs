<!-- views/admin/dashboard.ejs-->

<div class="dashboard-container">
  <%- include('../partials/sidebar') %>

  <div id="mainContent" class="main-content">
    <div class="welcome-header mb-4">
      <h2 class="dashboard-title">
        <i class="fas fa-tachometer-alt me-3"></i>
        Welcome back, <%= user.name %>!
      </h2>
      <p class="dashboard-subtitle">Here's what's happening with your BECE portal today</p>
      <div>
        <% if (user.role === 'superadmin') { %>
          <a href="/admin/users" class="btn btn-outline-primary btn-sm me-2 mb-2 mb-md-0">
            <i class="bi bi-people"></i> Manage Users
          </a>
        <% } %>
      </div>
    </div>

    <!-- Analytics Cards -->
    <div class="row g-4 mb-4">
      <!-- TOTAL STUDENTS -->
      <div class="col-xl-3 col-md-6">
        <div class="stats-card">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="stats-number" id="totalStudents"><%= analytics.totalStudents %></div>
              <div class="stats-label">Total Students</div>
            </div>
            <div class="stats-icon">
              <i class="fas fa-user-graduate fa-3x" style="color: var(--primary-color); opacity: 0.7;"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- TOTAL SCHOOLS -->
      <div class="col-xl-3 col-md-6">
        <div class="stats-card">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="stats-number" id="totalSchools"><%= analytics.totalSchools %></div>
              <div class="stats-label">Registered Schools</div>
            </div>
            <div class="stats-icon">
              <i class="fas fa-school fa-3x" style="color: var(--success-color); opacity: 0.7;"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- TOTAL PAYMENTS -->
      <div class="col-xl-3 col-md-6">
        <div class="stats-card">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="stats-number" id="totalPaid"><%= analytics.totalPayments %></div>
              <div class="stats-label">Successful Payments</div>
            </div>
            <div class="stats-icon">
              <i class="fas fa-credit-card fa-3x" style="color: var(--warning-color); opacity: 0.7;"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- MONTHLY REVENUE -->
      <div class="col-xl-3 col-md-6">
        <div class="stats-card">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="stats-number">₦<%= (analytics.monthlyRevenue || 0).toLocaleString() %></div>
              <div class="stats-label">Monthly Revenue</div>
            </div>
            <div class="stats-icon">
              <i class="fas fa-chart-line fa-3x" style="color: var(--info-color); opacity: 0.7;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row g-4 mb-4">
      <div class="col-lg-8 col-12">
        <div class="card border-0 shadow-sm rounded-4">
          <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
            <h5 class="fw-bold mb-0">Payments (Last 6 Months)</h5>
            <div>
              <button id="refreshCharts" class="btn btn-sm btn-outline-secondary">Refresh</button>
            </div>
          </div>
          <div class="card-body">
            <canvas id="paymentsChart" height="100"></canvas>
          </div>
        </div>
      </div>

      <div class="col-lg-4 col-12">
        <div class="card border-0 shadow-sm rounded-4">
          <div class="card-header bg-transparent border-0">
            <h5 class="fw-bold mb-0">Students by State</h5>
          </div>
          <div class="card-body">
            <canvas id="studentsStateChart" height="120"></canvas>
            <div class="mt-3">
              <h6 class="mb-2">Top States</h6>
              <ul id="topStatesList" class="list-unstyled small text-muted"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Activity & Charts -->
    <div class="row g-4">
      
      <!-- Recent Students -->
      <div class="col-lg-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
          <div class="card-header bg-transparent border-0">
            <h5 class="fw-bold mb-0">Recent Registrations</h5>
          </div>
          <div class="card-body">
            <ul class="list-group list-group-flush" id="recentStudentsList">
              <% if (analytics.recentStudents && analytics.recentStudents.length > 0) { %>
                <% analytics.recentStudents.forEach(student => { %>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="mb-1"><%= student.name %></h6>
                      <small class="text-muted"><%= student.School?.name || 'No School' %></small>
                    </div>
                    <span class="badge bg-<%= student.paymentStatus === 'Paid' ? 'success' : 'warning' %>">
                      <%= student.paymentStatus %>
                    </span>
                  </li>
                <% }) %>
              <% } else { %>
                <p class="text-muted text-center">No recent registrations</p>
              <% } %>
            </ul>
          </div>
        </div>
      </div>

      <!-- Recent Payments -->
      <div class="col-lg-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
          <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
            <h5 class="fw-bold mb-0">Recent Payments</h5>
            <a href="/admin/export/payments" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-download"></i> Export
            </a>
          </div>
          <div class="card-body">
            <ul class="list-group list-group-flush" id="recentPaymentsList">
              <% if (analytics.recentPayments && analytics.recentPayments.length > 0) { %>
                <% analytics.recentPayments.forEach(payment => { %>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="mb-1">₦<%= payment.amount %></h6>
                      <small class="text-muted"><%= payment.Student?.name || payment.email %></small>
                    </div>
                    <small class="text-muted"><%= payment.createdAt.toLocaleDateString() %></small>
                  </li>
                <% }) %>
              <% } else { %>
                <p class="text-muted text-center">No recent payments</p>
              <% } %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>


<!-- REAL-TIME ANALYTICS SCRIPT -->
<script>
async function refreshDashboard() {

  // LIVE COUNTERS
  const counters = await fetch('/admin/dashboard/live/counters').then(r => r.json());
  if (counters.success) {
    document.getElementById('totalStudents').textContent = counters.counters.students;
    document.getElementById('totalSchools').textContent = counters.counters.schools;
    document.getElementById('totalPaid').textContent = counters.counters.paid;
  }

  // LIVE RECENT ACTIVITY
  const recent = await fetch('/admin/dashboard/live/recent').then(r => r.json());
  if (recent.success) {
    document.getElementById('recentStudentsList').innerHTML =
      recent.recentStudents.map(s => `
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-1">${s.name}</h6>
            <small class="text-muted">${s.School?.name || "No School"}</small>
          </div>
          <span class="badge bg-${s.paymentStatus === "Paid" ? "success" : "warning"}">
            ${s.paymentStatus}
          </span>
        </li>
      `).join('');

    document.getElementById('recentPaymentsList').innerHTML =
      recent.recentPayments.map(p => `
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-1">₦${p.amount}</h6>
            <small class="text-muted">${p.Student?.name || p.email}</small>
          </div>
          <small class="text-muted">${new Date(p.createdAt).toLocaleDateString()}</small>
        </li>
      `).join('');
  }
}

// Mobile-optimized refresh intervals
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
const refreshInterval = isMobile ? 30000 : 10000; // 30s on mobile, 10s on desktop

// Only auto-refresh if page is visible
let refreshTimer;
function startRefresh() {
  if (!document.hidden) {
    refreshDashboard();
    refreshTimer = setTimeout(startRefresh, refreshInterval);
  }
}

// Pause refresh when page is hidden
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    clearTimeout(refreshTimer);
  } else {
    startRefresh();
  }
});

startRefresh();
</script>

<!-- Chart.js CDN and rendering -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let paymentsChart = null;
let studentsStateChart = null;
let _cachedStats = null;
let _cachedAt = 0;
const STATS_CACHE_MS = 30 * 1000; // 30 seconds

async function fetchDashboardStats() {
  const now = Date.now();
  if (_cachedStats && (now - _cachedAt) < STATS_CACHE_MS) {
    return _cachedStats;
  }

  const resp = await fetch('/admin/dashboard/stats');
  const json = await resp.json();
  if (json.success) {
    _cachedStats = json;
    _cachedAt = now;
  }
  return json;
}

async function renderPaymentsChart() {
  try {
    const json = await fetchDashboardStats();
    if (!json.success) return;

    const ctx = document.getElementById('paymentsChart').getContext('2d');
    const labels = json.chart.labels || [];
    const data = json.chart.data || [];

    if (paymentsChart) {
      paymentsChart.data.labels = labels;
      paymentsChart.data.datasets[0].data = data;
      paymentsChart.update();
      return;
    }

    paymentsChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Payments (₦)',
          data,
          borderColor: '#16a34a',
          backgroundColor: 'rgba(22,163,74,0.08)',
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                const v = context.raw || 0;
                return `₦${Number(v).toLocaleString()}`;
              }
            }
          }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  } catch (err) {
    console.error('Failed to render payments chart', err);
  }
}

async function renderStudentsByStateChart() {
  try {
    const json = await fetchDashboardStats();
    if (!json.success) return;

    const stateRows = json.studentsByState || [];
    const labels = stateRows.map(r => r.state || 'Unknown');
    const data = stateRows.map(r => Number(r.count) || 0);

    const ctx = document.getElementById('studentsStateChart').getContext('2d');

    if (studentsStateChart) {
      studentsStateChart.data.labels = labels;
      studentsStateChart.data.datasets[0].data = data;
      studentsStateChart.update();
    } else {
      studentsStateChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Students',
            data,
            backgroundColor: labels.map((_, i) => `hsl(${(i * 40) % 360} 70% 50%)`),
            borderColor: '#ffffff',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.formattedValue}` } } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Render top states list under the chart
    const topList = document.getElementById('topStatesList');
    if (topList) {
      topList.innerHTML = stateRows.slice(0, 6).map(r => `<li><strong>${r.state || 'Unknown'}</strong>: ${r.count}</li>`).join('');
    }
  } catch (err) {
    console.error('Failed to render students-by-state chart', err);
  }
}

async function renderAllCharts() {
  await Promise.all([renderPaymentsChart(), renderStudentsByStateChart()]);
}

renderAllCharts();

// Refresh button
document.getElementById('refreshCharts')?.addEventListener('click', () => {
  renderAllCharts();
});
</script>
