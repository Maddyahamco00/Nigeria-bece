<!-- views/admin/newResult.ejs -->
<div class="dashboard-container">
  <%- include('../partials/sidebar') %>

  <div id="mainContent" class="main-content">
    <div class="welcome-header mb-4">
      <h2 class="dashboard-title">
        <i class="fas fa-plus-circle me-3"></i>
        Upload Student Results
      </h2>
      <p class="dashboard-subtitle">Upload examination results for registered students</p>
    </div>

    <!-- Student Selection -->
    <div class="card shadow-sm border-0 rounded-4 mb-4">
      <div class="card-header bg-transparent border-0">
        <h5 class="fw-bold mb-0">
          <i class="fas fa-search me-2"></i>
          Select Student
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <label class="form-label fw-bold">Search Student</label>
            <input type="text" class="form-control" id="studentSearch" placeholder="Enter student name or registration number">
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold">Filter by School</label>
            <select class="form-control" id="schoolFilter">
              <option value="">All Schools</option>
              <% students.forEach(student => { %>
                <% if (student.School) { %>
                  <option value="<%= student.School.id %>"><%= student.School.name %></option>
                <% } %>
              <% }) %>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Students List -->
    <div class="row" id="studentsList">
      <% students.forEach(student => { %>
        <div class="col-lg-6 mb-4 student-card" data-student-id="<%= student.id %>" data-school-id="<%= student.School ? student.School.id : '' %>">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-primary text-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-0 fw-bold"><%= student.name %></h6>
                  <small>Reg: <%= student.regNumber || student.studentCode %></small>
                </div>
                <div>
                  <span class="badge bg-light text-primary">
                    <%= student.School ? student.School.name : 'No School' %>
                  </span>
                </div>
              </div>
            </div>
            <div class="card-body">
              <form action="/admin/results" method="POST" class="results-form">
                <input type="hidden" name="studentId" value="<%= student.id %>">
                
                <!-- Core Subjects -->
                <h6 class="fw-bold text-primary mb-3">
                  <i class="fas fa-book me-2"></i>Core Subjects
                </h6>
                <div class="row g-2 mb-3">
                  <div class="col-12">
                    <label class="form-label small fw-bold">English Language</label>
                    <div class="row g-1">
                      <div class="col-6">
                        <input type="number" class="form-control form-control-sm" name="subjects[english_ca]" min="0" max="40" placeholder="C.A (40)">
                        <small class="text-muted">Continuous Assessment</small>
                      </div>
                      <div class="col-6">
                        <input type="number" class="form-control form-control-sm" name="subjects[english_ex]" min="0" max="60" placeholder="Exam (60)">
                        <small class="text-muted">Examination</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-12">
                    <label class="form-label small fw-bold">Mathematics</label>
                    <div class="row g-1">
                      <div class="col-6">
                        <input type="number" class="form-control form-control-sm" name="subjects[mathematics_ca]" min="0" max="40" placeholder="C.A (40)">
                        <small class="text-muted">Continuous Assessment</small>
                      </div>
                      <div class="col-6">
                        <input type="number" class="form-control form-control-sm" name="subjects[mathematics_ex]" min="0" max="60" placeholder="Exam (60)">
                        <small class="text-muted">Examination</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-12">
                    <label class="form-label small fw-bold">Basic Science</label>
                    <div class="row g-1">
                      <div class="col-6">
                        <input type="number" class="form-control form-control-sm" name="subjects[basic_science_ca]" min="0" max="40" placeholder="C.A (40)">
                        <small class="text-muted">Continuous Assessment</small>
                      </div>
                      <div class="col-6">
                        <input type="number" class="form-control form-control-sm" name="subjects[basic_science_ex]" min="0" max="60" placeholder="Exam (60)">
                        <small class="text-muted">Examination</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-12">
                    <label class="form-label small fw-bold">Social Studies</label>
                    <div class="row g-1">
                      <div class="col-6">
                        <input type="number" class="form-control form-control-sm" name="subjects[social_studies_ca]" min="0" max="40" placeholder="C.A (40)">
                        <small class="text-muted">Continuous Assessment</small>
                      </div>
                      <div class="col-6">
                        <input type="number" class="form-control form-control-sm" name="subjects[social_studies_ex]" min="0" max="60" placeholder="Exam (60)">
                        <small class="text-muted">Examination</small>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Optional Subjects -->
                <h6 class="fw-bold text-secondary mb-3">
                  <i class="fas fa-plus-circle me-2"></i>Optional Subjects
                </h6>
                <div class="row g-2 mb-3">
                  <div class="col-12">
                    <label class="form-label small fw-bold">Civic Education</label>
                    <div class="row g-1">
                      <div class="col-6">
                        <input type="number" class="form-control form-control-sm" name="subjects[civic_education_ca]" min="0" max="40" placeholder="C.A (40)">
                      </div>
                      <div class="col-6">
                        <input type="number" class="form-control form-control-sm" name="subjects[civic_education_ex]" min="0" max="60" placeholder="Exam (60)">
                      </div>
                    </div>
                  </div>
                  <div class="col-12">
                    <label class="form-label small fw-bold">Business Studies</label>
                    <div class="row g-1">
                      <div class="col-6">
                        <input type="number" class="form-control form-control-sm" name="subjects[business_studies_ca]" min="0" max="40" placeholder="C.A (40)">
                      </div>
                      <div class="col-6">
                        <input type="number" class="form-control form-control-sm" name="subjects[business_studies_ex]" min="0" max="60" placeholder="Exam (60)">
                      </div>
                    </div>
                  </div>
                  <div class="col-12">
                    <label class="form-label small fw-bold">Arabic</label>
                    <div class="row g-1">
                      <div class="col-6">
                        <input type="number" class="form-control form-control-sm" name="subjects[arabic_ca]" min="0" max="40" placeholder="C.A (40)">
                      </div>
                      <div class="col-6">
                        <input type="number" class="form-control form-control-sm" name="subjects[arabic_ex]" min="0" max="60" placeholder="Exam (60)">
                      </div>
                    </div>
                  </div>
                  <div class="col-12">
                    <label class="form-label small fw-bold">Hausa</label>
                    <div class="row g-1">
                      <div class="col-6">
                        <input type="number" class="form-control form-control-sm" name="subjects[hausa_ca]" min="0" max="40" placeholder="C.A (40)">
                      </div>
                      <div class="col-6">
                        <input type="number" class="form-control form-control-sm" name="subjects[hausa_ex]" min="0" max="60" placeholder="Exam (60)">
                      </div>
                    </div>
                  </div>
                </div>

                <div class="d-grid">
                  <button type="submit" class="btn btn-success btn-sm">
                    <i class="fas fa-upload me-2"></i>
                    Upload Results
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      <% }) %>
    </div>

    <% if (!students || students.length === 0) { %>
      <div class="text-center py-5">
        <i class="fas fa-users fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No students found</h5>
        <p class="text-muted">Students need to register first before results can be uploaded.</p>
        <a href="/admin/students" class="btn btn-primary">
          <i class="fas fa-users me-2"></i>
          View Students
        </a>
      </div>
    <% } %>
  </div>
</div>

<script>
// Search functionality
document.getElementById('studentSearch').addEventListener('input', function(e) {
  const searchTerm = e.target.value.toLowerCase();
  filterStudents();
});

document.getElementById('schoolFilter').addEventListener('change', function(e) {
  filterStudents();
});

function filterStudents() {
  const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
  const schoolFilter = document.getElementById('schoolFilter').value;
  const studentCards = document.querySelectorAll('.student-card');

  studentCards.forEach(card => {
    const studentName = card.querySelector('h6').textContent.toLowerCase();
    const regNumber = card.querySelector('small').textContent.toLowerCase();
    const schoolId = card.dataset.schoolId;

    const matchesSearch = studentName.includes(searchTerm) || regNumber.includes(searchTerm);
    const matchesSchool = !schoolFilter || schoolId === schoolFilter;

    if (matchesSearch && matchesSchool) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  });
}

// Form submission with multiple subjects
document.querySelectorAll('.results-form').forEach(form => {
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(form);
    const studentId = formData.get('studentId');
    const subjects = {};
    
    // Collect CA and Exam scores and calculate totals
    const subjectPairs = {};
    for (let [key, value] of formData.entries()) {
      if (key.startsWith('subjects[') && value) {
        const fullKey = key.replace('subjects[', '').replace(']', '');
        const [subject, type] = fullKey.split('_ca').length > 1 ? [fullKey.replace('_ca', ''), 'ca'] : 
                               fullKey.split('_ex').length > 1 ? [fullKey.replace('_ex', ''), 'ex'] : [fullKey, 'total'];
        
        if (!subjectPairs[subject]) subjectPairs[subject] = {};
        subjectPairs[subject][type] = parseInt(value);
      }
    }

    // Calculate totals and submit
    for (let [subject, scores] of Object.entries(subjectPairs)) {
      const ca = scores.ca || 0;
      const ex = scores.ex || 0;
      const total = ca + ex;
      
      if (total > 0) {
        try {
          const response = await fetch('/admin/results', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `studentId=${studentId}&subject=${subject.replace('_', ' ')}&score=${total}&ca=${ca}&exam=${ex}`
          });
          
          if (!response.ok) {
            throw new Error('Failed to upload result');
          }
        } catch (error) {
          console.error('Error uploading result:', error);
          alert(`Failed to upload ${subject} result`);
          return;
        }
      }
    }
    
    alert('Results uploaded successfully with CA/Exam breakdown!');
    form.reset();
  });
});
</script>