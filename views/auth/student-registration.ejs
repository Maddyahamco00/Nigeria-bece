<!-- views/auth/student-registration.ejs -->

<main class="d-flex align-items-center justify-content-center py-5 min-vh-100">

  <div class="card shadow-lg border-0 rounded-4 p-4 w-100" style="max-width: 720px;">
    <div class="text-center mb-4">
      <img src="/images/logo.svg" alt="BECE Logo" class="mb-3" style="width: 70px;">
      <h2 class="fw-bold text-primary">Student Registration</h2>
      <p class="text-muted">Fill in your details to create an account</p>
    </div>

    <!-- Flash Messages -->
    <% if (messages.error) { %>
      <div class="alert alert-danger d-flex align-items-center">
        <i class="bi bi-exclamation-circle-fill me-2"></i>
        <div><%= messages.error %></div>
      </div>
    <% } %>

    <% if (messages.success) { %>
      <div class="alert alert-success d-flex align-items-center">
        <i class="bi bi-check-circle-fill me-2"></i>
        <div><%= messages.success %></div>
      </div>
    <% } %>

    <form action="/students/register" method="POST" class="row g-3" id="registrationForm">
      <!-- Inline client-side error placeholder -->
      <div id="formError" class="alert alert-danger d-none w-100" role="alert"></div>

      <input type="hidden" name="payment_ref" value="<%= preData.payment_reference || '' %>">

      <!-- Full Name -->
      <div class="col-md-6">
        <label for="name" class="form-label fw-bold">Full Name</label>
        <input id="name" type="text" name="name" class="form-control form-control-lg" 
               placeholder="Enter full name" value="<%= preData.name || '' %>" required>
      </div>

      <!-- Email -->
      <div class="col-md-6">
        <label for="email" class="form-label fw-bold">Email Address</label>
        <input id="email" type="email" name="email" class="form-control form-control-lg" 
               placeholder="Enter email" value="<%= preData.email || '' %>" required>
      </div>

      <!-- Password -->
      <div class="col-md-6">
        <label for="password" class="form-label fw-bold">Password</label>
        <input id="password" type="password" name="password" class="form-control form-control-lg" 
               placeholder="Enter password (min. 6 characters)" required minlength="6">
        <!-- Password Strength Meter -->
        <div class="password-strength mt-2">
          <div class="strength-meter">
            <div class="strength-fill" id="strengthFill"></div>
          </div>
          <small class="strength-text" id="strengthText">Password strength: Weak</small>
        </div>
      </div>

      <!-- Confirm Password -->
      <div class="col-md-6">
        <label for="confirmPassword" class="form-label fw-bold">Confirm Password</label>
        <input id="confirmPassword" type="password" name="confirmPassword" class="form-control form-control-lg" 
               placeholder="Confirm password" required minlength="6">
      </div>

      <!-- Gender -->
      <div class="col-md-6">
        <label for="gender" class="form-label fw-bold">Gender</label>
        <select id="gender" name="gender" class="form-select form-select-lg" required>
          <option value="">Select Gender</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
        </select>
      </div>

      <!-- Date of Birth -->
      <div class="col-md-6">
        <label for="dob" class="form-label fw-bold">Date of Birth</label>
        <input type="date" id="dob" name="dob" class="form-control form-control-lg" required>
      </div>

      <!-- Guardian Phone -->
      <div class="col-md-6">
        <label for="guardianPhone" class="form-label fw-bold">Guardian Phone</label>
        <input type="text" id="guardianPhone" name="guardianPhone" class="form-control form-control-lg" 
               placeholder="Enter phone number" value="<%= preData.guardian_number || '' %>" required>
      </div>

      <!-- State -->
      <div class="col-md-6">
        <label for="state" class="form-label fw-bold">State</label>
        <select id="state" name="stateId" class="form-select form-select-lg" required>
          <option value="">Select State</option>
          <% states.forEach(state => { %>
            <option value="<%= state.id %>"><%= state.name %></option>
          <% }) %>
        </select>
      </div>

      <!-- LGA -->
      <div class="col-md-6">
        <label for="lga" class="form-label fw-bold">LGA</label>
        <select id="lga" name="lgaId" class="form-select form-select-lg" required disabled>
          <option value="">Select LGA</option>
        </select>
      </div>

      <!-- School -->
      <div class="col-md-6">
        <label for="school" class="form-label fw-bold">School</label>
        <select id="school" name="schoolId" class="form-select form-select-lg" required disabled>
          <option value="">Select School</option>
        </select>
      </div>

      <!-- Subject Selection - FIXED VERSION -->
      <div class="col-12">
        <label class="form-label fw-bold mb-3">Select Subjects <small class="text-muted">(Choose at least 7 subjects)</small></label>
        <div class="border rounded p-3 bg-light">
          <% subjects.forEach((subject, index) => { 
            // Get the subject name properly
            const subjectName = subject.name || subject.subject_name || subject.subjectName || `Subject ${index + 1}`;
            
            // Check if it's Mathematics or English (case-insensitive)
            const isMathOrEnglish = 
              subjectName.toLowerCase().includes('math') || 
              subjectName.toLowerCase().includes('english');
          %>
            <div class="form-check mb-2">
              <% if (isMathOrEnglish) { %>
                <!-- Core subjects (Mathematics & English) - checked and disabled -->
                <input 
                  type="checkbox" 
                  name="subjects[]" 
                  value="<%= subject.id %>" 
                  id="subject-<%= subject.id %>" 
                  class="form-check-input"
                  checked 
                  disabled
                >
                <input type="hidden" name="subjects[]" value="<%= subject.id %>">
                <label for="subject-<%= subject.id %>" class="form-check-label fw-bold">
                  <%= subjectName %>
                  <span class="badge bg-success ms-2">Required</span>
                </label>
              <% } else { %>
                <!-- Other subjects - normal checkbox -->
                <input 
                  type="checkbox" 
                  name="subjects[]" 
                  value="<%= subject.id %>" 
                  id="subject-<%= subject.id %>" 
                  class="form-check-input"
                >
                <label for="subject-<%= subject.id %>" class="form-check-label">
                  <%= subjectName %>
                </label>
              <% } %>
            </div>
          <% }) %>
        </div>
        
        <!-- Selected count display -->
        <div class="mt-2">
          <small class="text-info">
            <i class="bi bi-info-circle"></i> 
            Selected: <span id="selected-count">2</span> subjects (Minimum: 5)
            <span class="ms-2 text-success">
              <i class="bi bi-check-circle"></i> Mathematics & English are required
            </span>
          </small>
        </div>
      </div>

      <!-- Payment Confirmation -->
      <div class="col-12">
        <div class="form-check">
          <input type="checkbox" id="payment" name="payment" class="form-check-input" required>
          <label for="payment" class="form-check-label">
            I confirm I have made the required payment
          </label>
        </div>
      </div>

      <!-- Submit -->
      <div class="col-12 d-grid mt-3">
        <button type="submit" id="registerBtn" class="btn btn-primary btn-lg fw-bold shadow-sm rounded-pill">
          <i class="bi bi-person-plus me-2"></i> Register Now
        </button>
      </div>

      <!-- Login Link -->
      <div class="col-12 text-center mt-3">
        <p class="text-muted">
          Already have an account? 
          <a href="/students/login" class="text-decoration-none fw-semibold text-primary">Login here</a>
        </p>
      </div>
    </form>
  </div>
</main>

<!-- Enhanced Dynamic Select Script -->
<script>
const stateSelect = document.getElementById('state');
const lgaSelect = document.getElementById('lga');
const schoolSelect = document.getElementById('school');
const form = document.getElementById('registrationForm');

// Subject selection tracking
const selectedCountElement = document.getElementById('selected-count');

function updateSelectedCount() {
  const checkboxes = document.querySelectorAll('input[name="subjects[]"]:not([disabled])');
  const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
  
  // Add 2 for the required subjects (Math & English)
  const totalSelected = checkedCount + 2;
  selectedCountElement.textContent = totalSelected;
  
  // Update color based on minimum requirement
  if (totalSelected >= 4) {
    selectedCountElement.classList.remove('text-warning');
    selectedCountElement.classList.add('text-success');
  } else {
    selectedCountElement.classList.remove('text-success');
    selectedCountElement.classList.add('text-warning');
  }
}

// Initialize subject count
document.addEventListener('DOMContentLoaded', function() {
  // Set initial count (2 for Math & English)
  selectedCountElement.textContent = '2';
  selectedCountElement.classList.add('text-success');
  
  // Add event listeners to all non-disabled subject checkboxes
  const subjectCheckboxes = document.querySelectorAll('input[name="subjects[]"]:not([disabled])');
  subjectCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateSelectedCount);
  });
});

stateSelect.addEventListener('change', async (e) => {
  const stateId = e.target.value;
  lgaSelect.innerHTML = '<option value="">Select LGA</option>';
  lgaSelect.disabled = true;
  schoolSelect.innerHTML = '<option value="">Select School</option>';
  schoolSelect.disabled = true;

  if (!stateId) return;

  try {
    const res = await fetch(`/api/lgas/${stateId}`);
    const lgas = await res.json();

    lgas.forEach(lga => {
      const option = document.createElement('option');
      option.value = lga.id;
      option.textContent = lga.name;
      lgaSelect.appendChild(option);
    });
    
    lgaSelect.disabled = false;
  } catch (err) {
    console.error('Error loading LGAs:', err);
    lgaSelect.innerHTML = '<option value="">Error loading LGAs</option>';
  }
});

lgaSelect.addEventListener('change', async (e) => {
  const lgaId = e.target.value;
  schoolSelect.innerHTML = '<option value="">Select School</option>';

  if (!lgaId) {
    schoolSelect.disabled = true;
    return;
  }

  try {
    const res = await fetch(`/api/schools/${lgaId}`);
    const schools = await res.json();

    schools.forEach(school => {
      const option = document.createElement('option');
      option.value = school.id;
      option.textContent = school.name;
      schoolSelect.appendChild(option);
    });

    schoolSelect.disabled = false;
  } catch (err) {
    console.error('Error loading schools:', err);
    schoolSelect.innerHTML = '<option value="">Error loading schools</option>';
  }
});

// Form validation (inline errors)
form.addEventListener('submit', (e) => {
  const password = document.getElementById('password');
  const confirmPassword = document.getElementById('confirmPassword');
  const guardianPhone = document.getElementById('guardianPhone');
  const errorEl = document.getElementById('formError');
  errorEl.classList.add('d-none');
  errorEl.textContent = '';

  // Password validation
  if (password.value !== confirmPassword.value) {
    e.preventDefault();
    errorEl.textContent = 'Passwords do not match!';
    errorEl.classList.remove('d-none');
    errorEl.focus();
    return false;
  }

  if (password.value.length < 6) {
    e.preventDefault();
    errorEl.textContent = 'Password must be at least 6 characters long!';
    errorEl.classList.remove('d-none');
    errorEl.focus();
    return false;
  }

  // Phone number validation
  if (!/^\d+$/.test(guardianPhone.value)) {
    e.preventDefault();
    errorEl.textContent = 'Guardian phone must contain digits only!';
    errorEl.classList.remove('d-none');
    guardianPhone.focus();
    return false;
  }

  // Subject selection validation (minimum 2 additional subjects)
  const checkboxes = document.querySelectorAll('input[name="subjects[]"]:not([disabled])');
  const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
  
  if (checkedCount < 2) { // Need at least 2 more subjects besides Math & English
    e.preventDefault();
    errorEl.textContent = 'Please select at least 2 additional subjects (4 total including Mathematics & English)!';
    errorEl.classList.remove('d-none');
    return false;
  }

  return true;
});
</script>